---
title: "Análisis de espectros promedidados"
author: "Andres Felipe Beltran"
date: "5/13/2021"
output:
   rmdformats::downcute:
params:
  lightbox = TRUE
  gallery = TRUE
---

# Introducción

En este documento revisamos el procedimiento para procesar mediante herramientas de análisis de datos los espectros promedidados resultantes de los experimentos que evalúan el efecto de la extracción a diferentes temperaturas, y distintas fuerzas iónicas.


# Importando datos a R

Primero, importamos los datos resultantes de cada etapa de promediado:

```{r}
ExpT <- read.table('promediosCandi.txt')
colnames(ExpT) <-as.numeric( sub('X', '', colnames(ExpT)) )
```

En el chunk anterior, se cargaron los espectros correspondientes al primer set de muestras, el cual contiene 16 muestras y se evalúan:

* Tiempo de molienda
* Temperatura de extracción
* Sección de la toma de muestra, codificada con un @ para la parte inferior del tubo.

Ahora cargamos los espectros del experimento con solución salina:

```{r}
ExpSS <- read.table('SSexp.txt')
colnames(ExpSS) <-as.numeric( sub('X', '', colnames(ExpSS)) )
ExpSS <- ExpSS[,-1869]
```


Luego, podemos juntar todos en un solo set de datos:

```{r}
data <- rbind(ExpT,ExpSS)
```

## Graficando los datos importados

podemos graficar todos los espectros contenidos en `data`:

```{r}
for(i in 1:71){
  plot(colnames(data),
       data[i,],
       type = 'l',
       ylim = c(0,0.35),
       xlim =  c(1700, 400),
       ylab = 'absorbance (a.u.)',
       xlab = 'wave number (cm-1)' )
  par(new = T)
}
```

# Análisis de datos

## Selección de rango

Una vez tenemos todas las muestras juntas, podemos seleccionar el rango de interés,  para no añadir el ruido debido a la corrección atmosfésrica, y a su vez, solo tomar las bandas características a los modos vibracionales de los enlaces Si-O, y los enlaces aromáticos de los monómeros de la lignina (Heitner 2010).

```{r}
colnames(data)[c(1,676)]
```
```{r}
data <- data[, 1:676]
wn <- as.numeric( colnames(data[1:676]))
```

## Corrección de línea base

Podemos eliminar la variabilidad por ruido instrumental de los espectros mediante el pre-tratamiento de estimación y corrección de línea base, mediante el método `rubberband` disponible en el paquete `hyperspec` de `R`, desarrollado para el análisis de imágenes hiper-espectrales.

```{r message=FALSE}
library(hyperSpec)
spc <- new('hyperSpec', spc = data, wavelength = wn)
bend <- 0.1 * wl.eval (spc, function (x) x^6+x^5+x^4+x^3+x^2, normalize.wl=normalize01)

bl <- spc.rubberband (spc+bend, noise = 1e-4, df=20)-bend
suma <- spc+bend
spc3 <- spc - bl

plot(spc, wl.reverse = TRUE)
plot(bl, add=TRUE, col=2,wl.reverse = TRUE)

plot(suma,wl.reverse = TRUE)
plot(bend, add=TRUE, col=2,wl.reverse = TRUE)

plot(spc3,wl.reverse = TRUE)

corregido <- as.data.frame(spc3[1:71])
corregido2 <- as.data.frame(corregido[,1])
```



## Análisis exploratorio con solo corrección de línea base



### Agrupamiento jerárquico

Esta técnica es útil en las etapas temprandas del análisis, cuando estamos tratando de entender los datos. Por ejemplo, cuando tratamos de encontrar patrones o relaciones entre distitnos factores o variables. Como su nombre lo indica, creamos una jerarquía de grupos.

El agrupamiento jerárquico es una aproximación aglomerativa de abajo hacia arriba. (Varmuza 2016)

El agrupamiento organiza las muestras que están más cerca en grupos. esto depende de varios factores:

* ¿Cómo definimos cerca?
* ¿Cómo agrupamos las muestras?
* ¿Cómo interpretamos el agrupamiento?



```{r meesage = FALSE}
library(factoextra)
df <- corregido2
library(factoextra)
res.hk <-hkmeans(df, 4)
names(res.hk)
```

```{r}
 options(ggrepel.max.overlaps = Inf)
fviz_dend(res.hk, cex = 0.6, palette = "jco", 
          rect = TRUE, rect_border = "jco", rect_fill = TRUE)
```


```{r}
fviz_cluster(res.hk, 
             palette = "jco", 
             repel = TRUE,
             ggtheme = theme_minimal(),
             labelsize = 5)
```


```{r}
dd <- dist(corregido2, method = "euclidean")
hc <- hclust(dd, method = "ward.D2")
plot(hc, 
     
     main = "Cluster dendrogram", 
      xlab = 'sample', 
     ylab = "Height",
     cex = 0.6)
```
```{r}
pca.bl <- prcomp(corregido2, scale =T, center = T)
vp.bl <- (pca.bl$sdev)^2
varianza.bl <- round(vp.bl/sum(vp.bl)*100, 2)
varianza.bl

```
```{r}
coord <- pca.bl$x

```

###

## Análisis exploratorio con corrección de línea base y cálculo de segunda derivada.

A partir de los espectros corregidos contenidos en `corregido2` podemos calcular las segundas derivadas utilizado la función `savitzkyGolay` disponible en el paquete `prospectr`:

```{r message= FALSE}
library(prospectr)

w2 <- 40

sg <- matrix(ncol = ncol(corregido2)-w2, nrow= nrow(corregido2))

sg <- as.data.frame(sg) 
sg<- savitzkyGolay(X = corregido2
                        ,m = 2,
                        p = 3,
                        w = w2+1,
                        delta.wav=2)
rownames(sg) <- rownames(corregido2)

for(i in 1:length(rownames(sg))){
  
  plot(as.numeric(colnames(sg)),
       sg[i,],
       xlab = 'wave number cm-1',
       ylab = '2nd derivative of abs',
       xlim = c(1700,400),
        ylim = c(-1e-04,1e-04),
       type = 'l',
       col = 1)
  par(new = T)
}  
  
```



```{r meesage = FALSE}
library(factoextra)
df.sg <- sg

res.hk.sg <-hkmeans(df.sg, 4)
names(res.hk.sg)
```


```{r}
 options(ggrepel.max.overlaps = Inf)
fviz_dend(res.hk, cex = 0.6, palette = "jco", 
          rect = TRUE, rect_border = "jco", rect_fill = TRUE)
```







```{r}
pca.bl.2d <- prcomp(sg, scale=T, center = T)

vp.bl.2d <- (pca.bl.2d$sdev)^2
varianza.bl.2d <- round(vp.bl.2d/sum(vp.bl.2d)*100, 2)
varianza.bl.2d

coord.bl.2d <- pca.bl.2d$x

plot(coord.bl.2d[,1],
     coord.bl.2d[,2],
     pch = 19,
     xlab = paste('PC 1 -',as.character(varianza.bl.2d[1]), '%'),
     ylab = paste('PC 2 -',as.character(varianza.bl.2d[2]), '%'),
     col = res.hk.sg$cluster
     )
abline()
```



```{r}
fviz_cluster(res.hk.sg, 
             palette = "jco", 
             repel = TRUE,
             ggtheme = theme_minimal(),
             labelsize = 5)
```

# Referencias

* Heitner, Cyril, Don Dimmel, and John Schmidt, eds. Lignin and lignans: advances in chemistry. CRC press, 2010, pp 122.
* Varmuza, K., & Filzmoser, P. (2016). Introduction to multivariate statistical analysis in chemometrics. CRC press.